<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='PTS-controller-contact-window-ContactDetail'>/**
</span> * The ContactDetail controller
 */
Ext.define('PTS.controller.contact.window.ContactDetail', {
    extend: 'Ext.app.Controller',

    views: [
        'contact.window.ContactDetail'
    ],
    models: [
        'Address',
        'EAddress',
        'Phone'
    ],
    stores: [
        'States'
    ],
    refs: [{
        ref: 'contactForm',
        selector: 'contactform'
    }],

    init: function() {

        this.control({
            'contactform contactdetail #sameAddCbx': {
                change: this.copyMailAddress
            },
            'contactform contactdetail countrycombo': {
                select: this.countryChange
            },
            'contactform addressfieldset #postalcode': {
                blur: this.onPostalBlur,
                validitychange: this.onPostalValidate
            },
            'contactform addressfieldset statecombo': {
                expand: this.onStateExpand
            }

        });

        // We listen for the application-wide loadcontact event
        this.application.on({
            loadcontact: this.onLoadContact,
            scope: this
        });
    },

<span id='PTS-controller-contact-window-ContactDetail-method-copyMailAddress'>    /**
</span>     * Copy the mailing address to the current form's physical address.
     *
     */
    copyMailAddress: function(cbx) {
        var phys = cbx.up('fieldset'),
            mail = cbx.up('contactdetail').down('#mailAddress');

        if(cbx.getValue()) {
            //copy vals from mailing fieldset
            Ext.each(mail.query('field'),function(itm){
                var val = itm.getValue(),
                    name = itm.getName(),
                    copy = phys.down('field[name='+name+']');

                if('addressid' !== name &amp;&amp; copy) {
                    //data[name] = val;
                    copy.setValue(val);
                    copy.disable();
                }
            });
        }else {
            //enable fields
            Ext.each(phys.query('field'),function(itm){
                itm.enable();
            });
        }
    },

<span id='PTS-controller-contact-window-ContactDetail-method-countryChange'>    /**
</span>     * Filter the state store when the country is changed.
     *
     */
    countryChange: function(cmb) {
        var stateStore = this.getStatesStore(),
            country = cmb.getValue();

        stateStore.clearFilter();
        this.filterState(country);
    },

<span id='PTS-controller-contact-window-ContactDetail-method-onPostalBlur'>    /**
</span>     * Actions to take when the postalcode field blurs.
     * TODO: Only works right now for US/CA.
     * TODO: Need to actually check to see if value has changed since last lookup instead of using isDirty.
     */
    onPostalBlur: function(fld) {
        var val = fld.getValue(),
            fldset = fld.up('addressfieldset'),
            country = fldset.down('#country').getValue();

        //look up the state and city
        if(fld.isDirty() &amp;&amp; !Ext.isEmpty(fld.getValue())) {
            Ext.Ajax.request({
                url: '../country/' + country + '/postalcode/' + val,
                success: function(response){
                    var state = fldset.down('#state'),
                        city = fldset.down('#city'),
                        data = Ext.decode(response.responseText).data;

                    state.setValue(data.stateid);
                    state.enable();
                    city.setValue(data.placename);
                    city.enable();
                },
                failure: function(response){
                    var msg = Ext.decode(response.responseText).message;

                    fld.markInvalid(msg);
                }
            });
        }
    },

<span id='PTS-controller-contact-window-ContactDetail-method-onPostalValidate'>    /**
</span>     * Actions to take when the postalcode field is validated.
     */
    onPostalValidate: function(fld,isValid) {
        var fldset = fld.up('addressfieldset');

            fldset.down('#state').setDisabled(!isValid);
            fldset.down('#city').setDisabled(!isValid);
    },

<span id='PTS-controller-contact-window-ContactDetail-method-onLoadContact'>    /**
</span>     * Check for null values in city and state for each addressfieldset
     * @param
     */
    onLoadContact: function(form, model) {
        var fields = form.query('#postalcode');

        Ext.each(fields, function(fld) {
            var cs = fld.up('addressfieldset').query('#city, #state'),
                empty = Ext.isEmpty(fld.getValue());

            Ext.each(cs, function(){
                this.setDisabled(empty);
            });

        });
    },

<span id='PTS-controller-contact-window-ContactDetail-method-onStateExpand'>    /**
</span>     * When the statecombo is expanded filter the statecombo store by country
     */
    onStateExpand: function(picker) {
        var val = picker.up('addressfieldset').down('countrycombo').getValue(),
            filter = this.getStatesStore().filters.get('country');

        //don't refilter with same value
        if(val &amp;&amp; !(filter &amp;&amp; (val === filter.value))) {
                this.filterState(val);
        }

    },

<span id='PTS-controller-contact-window-ContactDetail-method-filterState'>    /**
</span>     * Filter the statecombo store by country
     */
    filterState: function(val) {
        this.getStatesStore().filter({id: 'country', property: 'countryalpha', value: val});
    }
});
</pre>
</body>
</html>
